# IReader TTS (Text-to-Speech) Architecture

## ğŸ“– Overview

IReader's TTS system is a sophisticated multiplatform text-to-speech solution that supports both Android and Desktop platforms. It follows clean architecture principles with clear separation between UI, domain, and platform-specific implementations.

## ğŸ—ï¸ Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              PRESENTATION LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         TTSScreenSpec.kt                                 â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ TTSContentDisplayâ”‚  â”‚ TTSMediaControlsâ”‚  â”‚ TTSSettingsPanelCommon â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚           â”‚                    â”‚                       â”‚                 â”‚    â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚    â”‚
â”‚  â”‚                                â”‚                                         â”‚    â”‚
â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚    â”‚
â”‚  â”‚                    â”‚  CommonTTSScreenState â”‚                             â”‚    â”‚
â”‚  â”‚                    â”‚  CommonTTSActions     â”‚                             â”‚    â”‚
â”‚  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               DOMAIN LAYER                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      CommonTTSService (Interface)                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ startReading(bookId, chapterId)  â€¢ play() / pause() / stop()  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ nextChapter() / previousChapter() â€¢ setSpeed() / setPitch()   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ jumpToParagraph()  â€¢ setSleepTimer()  â€¢ setAutoNextChapter()  â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â–¼                             â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚     BaseTTSService.kt       â”‚  â”‚      TTSServiceState        â”‚               â”‚
â”‚  â”‚  (Shared Implementation)    â”‚  â”‚   (Reactive State Flows)    â”‚               â”‚
â”‚  â”‚  â€¢ Chapter loading          â”‚  â”‚  â€¢ isPlaying, isLoading     â”‚               â”‚
â”‚  â”‚  â€¢ Paragraph extraction     â”‚  â”‚  â€¢ currentBook, chapter     â”‚               â”‚
â”‚  â”‚  â€¢ Sleep timer logic        â”‚  â”‚  â€¢ speechSpeed, pitch       â”‚               â”‚
â”‚  â”‚  â€¢ Auto-next chapter        â”‚  â”‚  â€¢ cachedParagraphs         â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                 â”‚                                                                â”‚
â”‚                 â–¼                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        TTSEngine (Interface)                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ speak(text, utteranceId)  â€¢ stop() / pause() / resume()       â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ â€¢ setSpeed() / setPitch()   â€¢ setCallback()  â€¢ isReady()        â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PLATFORM LAYER                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                   â”‚                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚    â”‚                                                              â”‚               â”‚
â”‚    â–¼                                                              â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         ANDROID                  â”‚    â”‚            DESKTOP                   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                  â”‚    â”‚                                      â”‚  â”‚
â”‚  â”‚  AndroidTTSService               â”‚    â”‚  DesktopTTSService                   â”‚  â”‚
â”‚  â”‚  AndroidTTSServiceAdapter        â”‚    â”‚  DesktopTTSServiceAdapter            â”‚  â”‚
â”‚  â”‚  TTSStateImpl                    â”‚    â”‚  DesktopTTSState                     â”‚  â”‚
â”‚  â”‚                                  â”‚    â”‚                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚    TTS Engines          â”‚    â”‚    â”‚  â”‚      TTS Engines            â”‚     â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ NativeTTSPlayer       â”‚    â”‚    â”‚  â”‚ â€¢ PiperTTSEngine            â”‚     â”‚  â”‚
â”‚  â”‚  â”‚   (Android TextToSpeech)â”‚    â”‚    â”‚  â”‚ â€¢ KokoroTTSEngine           â”‚     â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ CoquiTTSPlayer        â”‚    â”‚    â”‚  â”‚ â€¢ MayaTTSEngine             â”‚     â”‚  â”‚
â”‚  â”‚  â”‚   (Hugging Face Space)  â”‚    â”‚    â”‚  â”‚ â€¢ CoquiTTSEngine            â”‚     â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ GradioTTSEngine       â”‚    â”‚    â”‚  â”‚ â€¢ GradioTTSEngine           â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â”‚ â€¢ SimulationTTSEngine       â”‚     â”‚  â”‚
â”‚  â”‚                                  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚                                      â”‚  â”‚
â”‚  â”‚  â”‚   Media Session         â”‚    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚   TTSService (Service)  â”‚    â”‚    â”‚  â”‚   Audio Playback            â”‚     â”‚  â”‚
â”‚  â”‚  â”‚   TTSNotificationBuilderâ”‚    â”‚    â”‚  â”‚   AudioPlaybackEngine       â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  â”‚   TTSAudioCache             â”‚     â”‚  â”‚
â”‚  â”‚                                  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ File Structure

```
domain/src/
â”œâ”€â”€ commonMain/kotlin/ireader/domain/services/tts_service/
â”‚   â”œâ”€â”€ CommonTTSService.kt      # Main interface for TTS operations
â”‚   â”œâ”€â”€ BaseTTSService.kt        # Shared implementation logic
â”‚   â”œâ”€â”€ TTSEngine.kt             # Engine abstraction interface
â”‚   â”œâ”€â”€ TTSNotification.kt       # Notification abstraction
â”‚   â”œâ”€â”€ TTSState.kt              # Common state interface
â”‚   â”œâ”€â”€ Player.kt                # Command constants
â”‚   â”œâ”€â”€ CoquiTTSEngine.kt        # Coqui/Hugging Face TTS
â”‚   â”œâ”€â”€ GenericGradioTTSEngine.kt # Generic Gradio TTS
â”‚   â”œâ”€â”€ GradioTTSConfig.kt       # Gradio configuration
â”‚   â”œâ”€â”€ GradioTTSManager.kt      # Gradio preset management
â”‚   â”œâ”€â”€ GradioTTSPresets.kt      # Pre-configured Gradio spaces
â”‚   â”œâ”€â”€ VoiceDownloader.kt       # Voice model download
â”‚   â”œâ”€â”€ VoiceStorage.kt          # Voice model storage
â”‚   â”œâ”€â”€ VoiceRecommender.kt      # Voice recommendation
â”‚   â””â”€â”€ LanguageDetector.kt      # Language detection
â”‚
â”œâ”€â”€ androidMain/kotlin/ireader/domain/services/tts_service/
â”‚   â”œâ”€â”€ AndroidTTSService.kt     # Android implementation
â”‚   â”œâ”€â”€ AndroidTTSServiceAdapter.kt # Adapter for CommonTTSService
â”‚   â”œâ”€â”€ AndroidTTSEngineFactory.kt  # Engine factory
â”‚   â”œâ”€â”€ AndroidTTSNotificationFactory.kt # Notification factory
â”‚   â”œâ”€â”€ TTSState.kt              # Android-specific state (TTSStateImpl)
â”‚   â”œâ”€â”€ UnifiedTTSPlayer.kt      # Native + Coqui player wrapper
â”‚   â”œâ”€â”€ IReaderVoice.kt          # Voice model for Android
â”‚   â””â”€â”€ media_player/
â”‚       â”œâ”€â”€ TTSService.kt        # Android MediaBrowserService
â”‚       â”œâ”€â”€ TTSNotificationBuilder.kt # Notification builder
â”‚       â””â”€â”€ AITTSPlayer.kt       # AI TTS audio player
â”‚
â””â”€â”€ desktopMain/kotlin/ireader/domain/services/tts_service/
    â”œâ”€â”€ DesktopTTSService.kt     # Desktop implementation
    â”œâ”€â”€ DesktopTTSServiceAdapter.kt # Adapter for CommonTTSService
    â”œâ”€â”€ DesktopTTSEngineFactory.kt  # Engine factory
    â”œâ”€â”€ DesktopTTSState.kt       # Desktop-specific state
    â”œâ”€â”€ TTSAudioCache.kt         # Audio caching
    â”œâ”€â”€ ChapterAudioDownloader.kt # Chapter audio export
    â”œâ”€â”€ engines/
    â”‚   â”œâ”€â”€ PiperTTSEngine.kt    # Piper TTS wrapper
    â”‚   â”œâ”€â”€ KokoroTTSEngine.kt   # Kokoro TTS wrapper
    â”‚   â”œâ”€â”€ MayaTTSEngine.kt     # Maya TTS wrapper
    â”‚   â””â”€â”€ SimulationTTSEngine.kt # Fallback engine
    â”œâ”€â”€ piper/
    â”‚   â”œâ”€â”€ PiperSpeechSynthesizer.kt # Piper synthesizer
    â”‚   â”œâ”€â”€ PiperModelManager.kt # Model management
    â”‚   â”œâ”€â”€ AudioPlaybackEngine.kt # Audio playback
    â”‚   â””â”€â”€ VoiceModel.kt        # Voice model data
    â”œâ”€â”€ kokoro/
    â”‚   â”œâ”€â”€ KokoroTTSEngine.kt   # Kokoro engine
    â”‚   â””â”€â”€ KokoroTTSAdapter.kt  # Adapter
    â””â”€â”€ maya/
        â”œâ”€â”€ MayaTTSEngine.kt     # Maya engine
        â””â”€â”€ MayaTTSAdapter.kt    # Adapter
```


## ğŸ”„ Data Flow

### 1. Starting TTS Playback

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User taps   â”‚â”€â”€â”€â”€â–¶â”‚  TTSScreenSpec  â”‚â”€â”€â”€â”€â–¶â”‚ CommonTTSService â”‚â”€â”€â”€â”€â–¶â”‚  TTSEngine  â”‚
â”‚  Play button â”‚     â”‚  (Composable)   â”‚     â”‚ .startReading()  â”‚     â”‚  .speak()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚  Load Book &     â”‚
                                             â”‚  Chapter from    â”‚
                                             â”‚  Repository      â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚  Extract         â”‚
                                             â”‚  Paragraphs      â”‚
                                             â”‚  from Content    â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚  Update State    â”‚
                                             â”‚  (StateFlow)     â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â”‚  Show            â”‚
                                             â”‚  Notification    â”‚
                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Paragraph Reading Cycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PARAGRAPH READING CYCLE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚   â”‚   START     â”‚                                                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â–¼                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ Get Current     â”‚â”€â”€â”€â”€â–¶â”‚ Send to TTS     â”‚â”€â”€â”€â”€â–¶â”‚ Engine speaks   â”‚       â”‚
â”‚   â”‚ Paragraph Text  â”‚     â”‚ Engine          â”‚     â”‚ text aloud      â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚                â”‚
â”‚                                                             â–¼                â”‚
â”‚                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                                                    â”‚ onDone callback â”‚       â”‚
â”‚                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚                â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚          â”‚                                                                   â”‚
â”‚          â–¼                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚   â”‚ Check Sleep     â”‚â”€â”€â”€â”€ Sleep expired? â”€â”€â”€â”€â–¶ STOP                          â”‚
â”‚   â”‚ Timer           â”‚                                                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚            â”‚ No                                                              â”‚
â”‚            â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚   â”‚ Is Last         â”‚â”€â”€â”€â”€ Yes + AutoNext â”€â”€â”€â”€â–¶ Load Next Chapter             â”‚
â”‚   â”‚ Paragraph?      â”‚                                                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚            â”‚ No                                                              â”‚
â”‚            â–¼                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚   â”‚ Increment       â”‚                                                        â”‚
â”‚   â”‚ Paragraph Index â”‚                                                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚            â”‚                                                                 â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ (Loop back to START)                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


## ğŸ¯ Key Components

### 1. CommonTTSService (Interface)

The main entry point for all TTS operations. Platform-specific implementations provide the actual functionality.

```kotlin
interface CommonTTSService {
    val state: TTSServiceState           // Reactive state
    
    suspend fun startReading(bookId: Long, chapterId: Long, autoPlay: Boolean = false)
    suspend fun play()
    suspend fun pause()
    suspend fun stop()
    suspend fun nextChapter()
    suspend fun previousChapter()
    suspend fun nextParagraph()
    suspend fun previousParagraph()
    suspend fun jumpToParagraph(index: Int)
    
    fun setSpeed(speed: Float)           // 0.5 - 2.0
    fun setPitch(pitch: Float)           // 0.5 - 2.0
    fun setSleepTimer(minutes: Int)
    fun setAutoNextChapter(enabled: Boolean)
    fun setCustomContent(content: List<String>?)  // For translations
    
    fun getAvailableEngines(): List<String>
    fun getCurrentEngineName(): String
}
```

### 2. TTSEngine (Interface)

Abstraction for different TTS engines (Native, Piper, Coqui, etc.)

```kotlin
interface TTSEngine {
    suspend fun speak(text: String, utteranceId: String)
    fun stop()
    fun pause()
    fun resume()
    fun setSpeed(speed: Float)
    fun setPitch(pitch: Float)
    fun setCallback(callback: TTSEngineCallback)
    fun isReady(): Boolean
    fun cleanup()
    fun getEngineName(): String
}
```

### 3. TTSServiceState (Interface)

Reactive state using Kotlin StateFlow for UI updates.

```kotlin
interface TTSServiceState {
    val isPlaying: StateFlow<Boolean>
    val isLoading: StateFlow<Boolean>
    val currentBook: StateFlow<Book?>
    val currentChapter: StateFlow<Chapter?>
    val currentParagraph: StateFlow<Int>
    val totalParagraphs: StateFlow<Int>
    val currentContent: StateFlow<List<String>>
    val speechSpeed: StateFlow<Float>
    val autoNextChapter: StateFlow<Boolean>
    val sleepTimeRemaining: StateFlow<Long>
    val cachedParagraphs: StateFlow<Set<Int>>  // For Coqui TTS caching
}
```

## ğŸ¤– TTS Engines

### Android Engines

| Engine | Description | Pros | Cons |
|--------|-------------|------|------|
| **Native TTS** | Android's built-in TextToSpeech | No internet, fast | Quality varies by device |
| **Coqui TTS** | Hugging Face Space | High quality neural voices | Requires internet |
| **Gradio TTS** | Generic Gradio spaces | Flexible, many options | Requires internet |

### Desktop Engines

| Engine | Description | Pros | Cons |
|--------|-------------|------|------|
| **Piper** | Local neural TTS | High quality, offline | Requires model download |
| **Kokoro** | Local TTS engine | Good quality, offline | Limited voices |
| **Maya** | Local TTS engine | Lightweight | Basic quality |
| **Coqui TTS** | Hugging Face Space | High quality | Requires internet |
| **Gradio TTS** | Generic Gradio spaces | Flexible | Requires internet |
| **Simulation** | Fallback engine | Always available | No actual audio |


## ğŸ“± Platform Implementations

### Android Implementation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ANDROID TTS ARCHITECTURE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    AndroidTTSServiceAdapter                          â”‚    â”‚
â”‚  â”‚              (implements CommonTTSService)                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                          â”‚
â”‚                                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         TTSStateImpl                                 â”‚    â”‚
â”‚  â”‚                  (implements AndroidTTSState)                        â”‚    â”‚
â”‚  â”‚  â€¢ MutableStateFlow for all state                                    â”‚    â”‚
â”‚  â”‚  â€¢ Android-specific: voices, languages, MediaMetadata                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                          â”‚
â”‚                                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    TTSService (MediaBrowserService)                  â”‚    â”‚
â”‚  â”‚  â€¢ Foreground service for background playback                        â”‚    â”‚
â”‚  â”‚  â€¢ MediaSession integration for lock screen controls                 â”‚    â”‚
â”‚  â”‚  â€¢ Notification with playback controls                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                          â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚           â–¼                       â–¼                       â–¼                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ NativeTTSPlayer â”‚   â”‚ CoquiTTSPlayer  â”‚   â”‚ GradioTTSEngine â”‚            â”‚
â”‚  â”‚ (TextToSpeech)  â”‚   â”‚ (HTTP Client)   â”‚   â”‚ (HTTP Client)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Desktop Implementation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DESKTOP TTS ARCHITECTURE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                   DesktopTTSServiceAdapter                           â”‚    â”‚
â”‚  â”‚              (implements CommonTTSService)                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                          â”‚
â”‚                                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                       DesktopTTSState                                â”‚    â”‚
â”‚  â”‚  â€¢ MutableStateFlow for all state                                    â”‚    â”‚
â”‚  â”‚  â€¢ Desktop-specific: VoiceModel, WordBoundary, DownloadProgress      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                          â”‚
â”‚                                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      DesktopTTSService                               â”‚    â”‚
â”‚  â”‚  â€¢ Engine management (Piper, Kokoro, Maya, Coqui)                    â”‚    â”‚
â”‚  â”‚  â€¢ Audio caching (TTSAudioCache)                                     â”‚    â”‚
â”‚  â”‚  â€¢ Chapter audio download                                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚     â–¼                             â–¼                             â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ PiperTTS     â”‚   â”‚ KokoroTTS / MayaTTS  â”‚   â”‚ Coqui / Gradio TTS   â”‚     â”‚
â”‚  â”‚ Engine       â”‚   â”‚ Engines              â”‚   â”‚ (HTTP Client)        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    AudioPlaybackEngine                                â”‚   â”‚
â”‚  â”‚  â€¢ Platform-specific audio (Windows/macOS/Linux)                      â”‚   â”‚
â”‚  â”‚  â€¢ WAV playback from synthesized audio                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


## ğŸ¨ UI Components

### Presentation Layer Structure

```
presentation/src/commonMain/kotlin/ireader/presentation/
â”œâ”€â”€ core/ui/
â”‚   â”œâ”€â”€ TTSScreenSpec.kt              # Main TTS screen (entry point)
â”‚   â””â”€â”€ TTSEngineManagerScreenSpec.kt # Engine settings (expect/actual)
â”‚
â””â”€â”€ ui/home/tts/
    â”œâ”€â”€ CommonTTSScreen.kt            # Shared UI components
    â”‚   â”œâ”€â”€ CommonTTSScreenState      # UI state data class
    â”‚   â”œâ”€â”€ CommonTTSActions          # UI action interface
    â”‚   â”œâ”€â”€ TTSContentDisplay         # Paragraph display with highlighting
    â”‚   â”œâ”€â”€ TTSMediaControls          # Play/pause/skip controls
    â”‚   â””â”€â”€ TTSSettingsPanelCommon    # Settings overlay
    â”‚
    â”œâ”€â”€ TTSTopBar.kt                  # Top app bar
    â””â”€â”€ UnifiedTTSScreen.kt           # Alternative unified screen
```

### UI State Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           UI STATE MANAGEMENT                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    TTSScreenSpec.kt                                  â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚   val ttsService: CommonTTSService = koinInject()                    â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚   // Collect state from service                                      â”‚    â”‚
â”‚  â”‚   val isPlaying by ttsService.state.isPlaying.collectAsState()       â”‚    â”‚
â”‚  â”‚   val currentParagraph by ttsService.state.currentParagraph.collectAsState()â”‚
â”‚  â”‚   val content by ttsService.state.currentContent.collectAsState()    â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚   // Create UI state                                                 â”‚    â”‚
â”‚  â”‚   val screenState = CommonTTSScreenState(                            â”‚    â”‚
â”‚  â”‚       currentReadingParagraph = currentParagraph,                    â”‚    â”‚
â”‚  â”‚       isPlaying = isPlaying,                                         â”‚    â”‚
â”‚  â”‚       content = content,                                             â”‚    â”‚
â”‚  â”‚       ...                                                            â”‚    â”‚
â”‚  â”‚   )                                                                  â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚   // Create actions                                                  â”‚    â”‚
â”‚  â”‚   val actions = object : CommonTTSActions {                          â”‚    â”‚
â”‚  â”‚       override fun onPlay() { scope.launch { ttsService.play() } }   â”‚    â”‚
â”‚  â”‚       override fun onPause() { scope.launch { ttsService.pause() } } â”‚    â”‚
â”‚  â”‚       ...                                                            â”‚    â”‚
â”‚  â”‚   }                                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚                                   â”‚                                          â”‚
â”‚                                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    UI Components                                     â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚   TTSContentDisplay(state, actions, ...)                             â”‚    â”‚
â”‚  â”‚   TTSMediaControls(state, actions, ...)                              â”‚    â”‚
â”‚  â”‚   TTSSettingsPanelCommon(...)                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


## ğŸ”§ Features

### Core Features

| Feature | Description | Implementation |
|---------|-------------|----------------|
| **Paragraph Highlighting** | Current paragraph is highlighted during playback | `currentParagraph` StateFlow + UI styling |
| **Auto-scroll** | UI scrolls to current paragraph | `LaunchedEffect` with `animateScrollToItem` |
| **Speed Control** | Adjustable speech rate (0.5x - 2.0x) | `setSpeed()` on TTSEngine |
| **Sleep Timer** | Auto-stop after set duration | `sleepTimerJob` in BaseTTSService |
| **Auto-next Chapter** | Automatically load next chapter | `handleParagraphComplete()` logic |
| **Translation Support** | Read translated content | `setCustomContent()` method |
| **Bilingual Mode** | Show original + translated text | UI toggle in CommonTTSScreenState |

### Platform-Specific Features

#### Android
- **Foreground Service**: Background playback with notification
- **MediaSession**: Lock screen and Bluetooth controls
- **Audio Focus**: Proper handling of audio interruptions
- **System TTS Voices**: Access to device's installed voices

#### Desktop
- **Multiple Engines**: Piper, Kokoro, Maya, Coqui, Gradio
- **Voice Model Download**: Download and manage voice models
- **Audio Caching**: Cache synthesized audio for faster playback
- **Chapter Export**: Download entire chapter as audio file
- **Word Boundary**: Highlight current word (Piper)

## ğŸŒ Gradio TTS Integration

The system supports any Gradio-based TTS space through `GenericGradioTTSEngine`:

```kotlin
data class GradioTTSConfig(
    val id: String,
    val name: String,
    val spaceUrl: String,
    val apiEndpoint: String = "/api/predict",
    val parameters: List<GradioParam>,
    val textParamIndex: Int = 0,
    val audioOutputIndex: Int = 0,
    val isEnabled: Boolean = true,
    val isCustom: Boolean = false
)

// Pre-configured presets available in GradioTTSPresets.kt
object GradioTTSPresets {
    val COQUI_XTTS = GradioTTSConfig(...)
    val BARK = GradioTTSConfig(...)
    val PARLER_TTS = GradioTTSConfig(...)
    // ... more presets
}
```


## ğŸ”Œ Dependency Injection (Koin)

The TTS system uses Koin for dependency injection:

```kotlin
// In DI module
val ttsModule = module {
    // Common
    single<CommonTTSService> { 
        // Platform-specific implementation injected
        get<PlatformTTSService>() 
    }
    
    // Android
    single { TTSStateImpl() }
    single { AndroidTTSServiceAdapter(get(), get(), ...) }
    
    // Desktop
    single { DesktopTTSState() }
    single { DesktopTTSServiceAdapter(get()) }
}

// Usage in Composable
@Composable
fun TTSScreen() {
    val ttsService: CommonTTSService = koinInject()
    // ...
}
```

## ğŸ“Š State Management

### StateFlow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STATE FLOW ARCHITECTURE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Service Layer                    UI Layer                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚                                                                              â”‚
â”‚   MutableStateFlow<Boolean>        collectAsState()                          â”‚
â”‚   _isPlaying â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ isPlaying                                â”‚
â”‚                                                                              â”‚
â”‚   MutableStateFlow<Int>            collectAsState()                          â”‚
â”‚   _currentParagraph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ currentParagraph                         â”‚
â”‚                                                                              â”‚
â”‚   MutableStateFlow<List<String>>   collectAsState()                          â”‚
â”‚   _currentContent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ content                                  â”‚
â”‚                                                                              â”‚
â”‚   MutableStateFlow<Float>          collectAsState()                          â”‚
â”‚   _speechSpeed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ speechSpeed                              â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Benefits:                                                           â”‚   â”‚
â”‚   â”‚  â€¢ Automatic UI updates when state changes                           â”‚   â”‚
â”‚   â”‚  â€¢ Thread-safe state management                                      â”‚   â”‚
â”‚   â”‚  â€¢ Lifecycle-aware collection in Compose                             â”‚   â”‚
â”‚   â”‚  â€¢ Easy testing with fake StateFlows                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª Testing

### Unit Testing

```kotlin
class TTSServiceTest {
    @Test
    fun `startReading loads chapter content`() = runTest {
        val service = FakeTTSService()
        
        service.startReading(bookId = 1, chapterId = 1)
        
        assertEquals(expectedContent, service.state.currentContent.value)
    }
}
```

### Integration Testing

```kotlin
class TTSIntegrationTest {
    @Test
    fun `paragraph cycle completes correctly`() = runTest {
        val service = createRealService()
        val engine = FakeTTSEngine()
        
        service.startReading(1, 1, autoPlay = true)
        
        // Simulate engine completion
        engine.simulateCompletion()
        
        assertEquals(1, service.state.currentParagraph.value)
    }
}
```


## ğŸš€ Usage Examples

### Starting TTS from Reader

```kotlin
// In ReaderScreen
fun openTTSScreen(book: Book, chapter: Chapter, paragraph: Int) {
    navigator.navigate(
        TTSScreenSpec(
            bookId = book.id,
            chapterId = chapter.id,
            sourceId = book.sourceId,
            readingParagraph = paragraph
        )
    )
}
```

### Controlling TTS Programmatically

```kotlin
class MyViewModel(
    private val ttsService: CommonTTSService
) : ViewModel() {
    
    fun startReading(bookId: Long, chapterId: Long) {
        viewModelScope.launch {
            ttsService.startReading(bookId, chapterId, autoPlay = true)
        }
    }
    
    fun togglePlayPause() {
        viewModelScope.launch {
            if (ttsService.state.isPlaying.value) {
                ttsService.pause()
            } else {
                ttsService.play()
            }
        }
    }
    
    fun setSpeed(speed: Float) {
        ttsService.setSpeed(speed)
    }
}
```

### Reading Translated Content

```kotlin
// Load translation
val translatedContent = translationRepository.getTranslation(chapterId)

// Set custom content for TTS
ttsService.setCustomContent(translatedContent)

// To restore original content
ttsService.setCustomContent(null)
```

## ğŸ“ Adding a New TTS Engine

### 1. Implement TTSEngine Interface

```kotlin
class MyCustomTTSEngine : TTSEngine {
    private var callback: TTSEngineCallback? = null
    
    override suspend fun speak(text: String, utteranceId: String) {
        callback?.onStart(utteranceId)
        // Your TTS logic here
        callback?.onDone(utteranceId)
    }
    
    override fun stop() { /* ... */ }
    override fun pause() { /* ... */ }
    override fun resume() { /* ... */ }
    override fun setSpeed(speed: Float) { /* ... */ }
    override fun setPitch(pitch: Float) { /* ... */ }
    override fun setCallback(callback: TTSEngineCallback) {
        this.callback = callback
    }
    override fun isReady(): Boolean = true
    override fun cleanup() { /* ... */ }
    override fun getEngineName(): String = "My Custom TTS"
}
```

### 2. Register in Factory

```kotlin
// In TTSEngineFactory (platform-specific)
fun createMyCustomEngine(): TTSEngine? {
    return try {
        MyCustomTTSEngine()
    } catch (e: Exception) {
        null
    }
}
```

### 3. Add to Available Engines

```kotlin
fun getAvailableEngines(): List<String> {
    return listOf(
        "Native",
        "Piper",
        "My Custom TTS"  // Add here
    )
}
```

## ğŸ”’ Security Considerations

- **API Keys**: Store securely, never in code
- **Network Requests**: Use HTTPS for all TTS API calls
- **Input Sanitization**: Sanitize text before sending to TTS
- **Model Verification**: Verify checksums for downloaded models

## ğŸ“š Related Documentation

- [Gradio TTS README](../domain/src/commonMain/kotlin/ireader/domain/services/tts_service/GRADIO_TTS_README.md)
- [Piper TTS README](../domain/src/desktopMain/kotlin/ireader/domain/services/tts_service/piper/README.md)
- [Desktop TTS README](../domain/src/desktopMain/kotlin/ireader/domain/services/tts_service/README.md)
- [Platform Audio README](../domain/src/desktopMain/kotlin/ireader/domain/services/tts_service/piper/PLATFORM_AUDIO_README.md)


## ğŸ“‹ Complete Class Reference

### Common (Shared) Classes

| Class/Interface | File | Purpose |
|-----------------|------|---------|
| `CommonTTSService` | CommonTTSService.kt | Main TTS service interface |
| `TTSServiceState` | CommonTTSService.kt | Reactive state interface |
| `TTSServiceAction` | CommonTTSService.kt | Sealed class for actions |
| `TTSServiceEvent` | CommonTTSService.kt | Sealed class for events |
| `BaseTTSService` | BaseTTSService.kt | Shared implementation |
| `TTSEngine` | TTSEngine.kt | Engine abstraction |
| `TTSEngineCallback` | TTSEngine.kt | Engine event callback |
| `TTSEngineConfig` | TTSEngine.kt | Engine configuration |
| `TTSNotification` | TTSNotification.kt | Notification abstraction |
| `TTSNotificationData` | TTSNotification.kt | Notification data |
| `TTSState` | TTSState.kt | Common state interface |
| `Player` | Player.kt | Command constants |
| `GenericGradioTTSEngine` | GenericGradioTTSEngine.kt | Unified Gradio/Coqui TTS engine |
| `CoquiAudioPlayer` | GenericGradioTTSEngine.kt | Audio player interface |
| `GradioTTSConfig` | GradioTTSConfig.kt | Gradio configuration |
| `GradioTTSManager` | GradioTTSManager.kt | Gradio preset manager |
| `GradioTTSPresets` | GradioTTSPresets.kt | Pre-configured presets (incl. Coqui) |
| `VoiceDownloader` | VoiceDownloader.kt | Voice download service |
| `VoiceStorage` | VoiceStorage.kt | Voice storage service |
| `VoiceRecommender` | VoiceRecommender.kt | Voice recommendation |
| `LanguageDetector` | LanguageDetector.kt | Language detection |

### Android Classes

| Class | File | Purpose |
|-------|------|---------|
| `AndroidTTSService` | AndroidTTSService.kt | Android implementation |
| `AndroidTTSServiceAdapter` | AndroidTTSServiceAdapter.kt | CommonTTSService adapter |
| `TTSStateImpl` | TTSState.kt | Android state implementation |
| `AndroidTTSState` | TTSState.kt | Android state interface |
| `UnifiedTTSPlayer` | UnifiedTTSPlayer.kt | Native + Coqui wrapper |
| `NativeTTSPlayer` | UnifiedTTSPlayer.kt | Android TextToSpeech |
| `CoquiTTSPlayer` | UnifiedTTSPlayer.kt | Coqui HTTP client |
| `TTSService` | media_player/TTSService.kt | MediaBrowserService |
| `TTSNotificationBuilder` | media_player/TTSNotificationBuilder.kt | Notification builder |
| `AITTSPlayer` | media_player/AITTSPlayer.kt | AI TTS audio player |
| `AndroidTTSEngineFactory` | AndroidTTSEngineFactory.kt | Engine factory |
| `AndroidTTSNotificationFactory` | AndroidTTSNotificationFactory.kt | Notification factory |

### Desktop Classes

| Class | File | Purpose |
|-------|------|---------|
| `DesktopTTSService` | DesktopTTSService.kt | Desktop implementation |
| `DesktopTTSServiceAdapter` | DesktopTTSServiceAdapter.kt | CommonTTSService adapter |
| `DesktopTTSState` | DesktopTTSState.kt | Desktop state |
| `DesktopTTSEngineFactory` | DesktopTTSEngineFactory.kt | Engine factory |
| `PiperTTSEngine` | engines/PiperTTSEngine.kt | Piper wrapper |
| `KokoroTTSEngine` | engines/KokoroTTSEngine.kt | Kokoro wrapper |
| `MayaTTSEngine` | engines/MayaTTSEngine.kt | Maya wrapper |
| `SimulationTTSEngine` | engines/SimulationTTSEngine.kt | Fallback engine |
| `PiperSpeechSynthesizer` | piper/PiperSpeechSynthesizer.kt | Piper synthesizer |
| `PiperModelManager` | piper/PiperModelManager.kt | Model management |
| `AudioPlaybackEngine` | piper/AudioPlaybackEngine.kt | Audio playback |
| `TTSAudioCache` | TTSAudioCache.kt | Audio caching |
| `ChapterAudioDownloader` | ChapterAudioDownloader.kt | Chapter export |

### Presentation Classes

| Class | File | Purpose |
|-------|------|---------|
| `TTSScreenSpec` | core/ui/TTSScreenSpec.kt | Main TTS screen |
| `TTSEngineManagerScreenSpec` | core/ui/TTSEngineManagerScreenSpec.kt | Engine settings |
| `CommonTTSScreenState` | home/tts/CommonTTSScreen.kt | UI state |
| `CommonTTSActions` | home/tts/CommonTTSScreen.kt | UI actions interface |
| `TTSContentDisplay` | home/tts/CommonTTSScreen.kt | Content display |
| `TTSMediaControls` | home/tts/CommonTTSScreen.kt | Media controls |
| `TTSSettingsPanelCommon` | home/tts/CommonTTSScreen.kt | Settings panel |
| `TTSTopBar` | home/tts/TTSTopBar.kt | Top app bar |

---

*Last updated: November 2025*
