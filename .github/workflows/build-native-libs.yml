name: Build Native Libraries

on:
  push:
    branches: [ main, develop, 'feature/piper-jni-*' ]
    paths:
      - 'native/**'
      - '.github/workflows/build-native-libs.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'native/**'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows x64
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup CMake
        uses: lukka/get-cmake@latest
      
      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2
      
      - name: Build Windows library
        run: |
          cd native
          cmake -S . -B build/windows -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
          cmake --build build/windows --config Release --parallel
      
      - name: Run tests
        run: |
          cd native/build/windows
          ctest --build-config Release --output-on-failure
      
      - name: Verify library
        run: |
          if (Test-Path native/build/windows/Release/piper_jni.dll) {
            Write-Host "✓ Library built successfully"
            $size = (Get-Item native/build/windows/Release/piper_jni.dll).Length
            Write-Host "Size: $([math]::Round($size/1KB, 2)) KB"
          } else {
            Write-Error "Library not found!"
            exit 1
          }
      
      - name: Upload Windows library
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-libs
          path: |
            native/build/windows/Release/piper_jni.dll
            domain/src/desktopMain/resources/native/windows/piper_jni.dll
          retention-days: 30

  build-macos-x64:
    name: Build macOS x64
    runs-on: macos-13  # Intel Mac
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup CMake
        uses: lukka/get-cmake@latest
      
      - name: Build macOS x64 library
        run: |
          cd native
          chmod +x scripts/build_macos.sh
          ./scripts/build_macos.sh release
      
      - name: Run tests
        run: |
          cd native/build/macos-x64
          ctest --build-config Release --output-on-failure
      
      - name: Verify library
        run: |
          if [ -f native/build/macos-x64/libpiper_jni.dylib ]; then
            echo "✓ Library built successfully"
            ls -lh native/build/macos-x64/libpiper_jni.dylib
            lipo -info native/build/macos-x64/libpiper_jni.dylib
          else
            echo "Library not found!"
            exit 1
          fi
      
      - name: Upload macOS x64 library
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64-libs
          path: |
            native/build/macos-x64/libpiper_jni.dylib
            domain/src/desktopMain/resources/native/macos-x64/libpiper_jni.dylib
          retention-days: 30

  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-14  # Apple Silicon Mac
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup CMake
        uses: lukka/get-cmake@latest
      
      - name: Build macOS ARM64 library
        run: |
          cd native
          chmod +x scripts/build_macos.sh
          ./scripts/build_macos.sh release
      
      - name: Run tests
        run: |
          cd native/build/macos-arm64
          ctest --build-config Release --output-on-failure
      
      - name: Verify library
        run: |
          if [ -f native/build/macos-arm64/libpiper_jni.dylib ]; then
            echo "✓ Library built successfully"
            ls -lh native/build/macos-arm64/libpiper_jni.dylib
            lipo -info native/build/macos-arm64/libpiper_jni.dylib
          else
            echo "Library not found!"
            exit 1
          fi
      
      - name: Upload macOS ARM64 library
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-libs
          path: |
            native/build/macos-arm64/libpiper_jni.dylib
            domain/src/desktopMain/resources/native/macos-arm64/libpiper_jni.dylib
          retention-days: 30

  build-linux:
    name: Build Linux x64
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup CMake
        uses: lukka/get-cmake@latest
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libasound2-dev
      
      - name: Build Linux library
        run: |
          cd native
          chmod +x scripts/build_linux.sh
          ./scripts/build_linux.sh release
      
      - name: Run tests
        run: |
          cd native/build/linux
          ctest --build-config Release --output-on-failure
      
      - name: Verify library
        run: |
          if [ -f native/build/linux/libpiper_jni.so ]; then
            echo "✓ Library built successfully"
            ls -lh native/build/linux/libpiper_jni.so
            ldd native/build/linux/libpiper_jni.so | head -10
          else
            echo "Library not found!"
            exit 1
          fi
      
      - name: Upload Linux library
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-libs
          path: |
            native/build/linux/libpiper_jni.so
            domain/src/desktopMain/resources/native/linux/libpiper_jni.so
          retention-days: 30

  package-release:
    name: Package Release
    needs: [build-windows, build-macos-x64, build-macos-arm64, build-linux]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create release package
        run: |
          mkdir -p release/native
          
          # Copy Windows library
          cp artifacts/windows-x64-libs/native/build/windows/Release/piper_jni.dll release/native/windows-piper_jni.dll || true
          
          # Copy macOS libraries
          cp artifacts/macos-x64-libs/native/build/macos-x64/libpiper_jni.dylib release/native/macos-x64-libpiper_jni.dylib || true
          cp artifacts/macos-arm64-libs/native/build/macos-arm64/libpiper_jni.dylib release/native/macos-arm64-libpiper_jni.dylib || true
          
          # Copy Linux library
          cp artifacts/linux-x64-libs/native/build/linux/libpiper_jni.so release/native/linux-libpiper_jni.so || true
          
          # Create checksums
          cd release/native
          sha256sum * > checksums.txt
          cd ../..
          
          # Create archive
          tar -czf piper-jni-libs-$(date +%Y%m%d-%H%M%S).tar.gz -C release native
      
      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: piper-jni-release
          path: piper-jni-libs-*.tar.gz
          retention-days: 90
      
      - name: Display summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All platform libraries built successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Libraries:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Windows x64" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ macOS x64 (Intel)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ macOS ARM64 (Apple Silicon)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Linux x64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
          ls -lh release/native/ >> $GITHUB_STEP_SUMMARY
