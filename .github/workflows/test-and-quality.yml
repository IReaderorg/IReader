name: Test and Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Run unit tests
        run: ./gradlew test --stacktrace
        
      - name: Run integration tests
        run: ./gradlew connectedAndroidTest --stacktrace
        continue-on-error: true
        
      - name: Generate test report
        if: always()
        run: ./gradlew testDebugUnitTest
        
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: '**/build/test-results/**/*.xml'
          
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-reports
          path: '**/build/reports/tests/**'

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Generate coverage report
        run: ./gradlew jacocoTestReport --stacktrace
        continue-on-error: true
        
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: '**/build/reports/jacoco/**/*.xml'
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: '**/build/reports/jacoco/**'

  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Run Detekt
        run: ./gradlew detekt --stacktrace
        continue-on-error: true
        
      - name: Upload Detekt reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: detekt-reports
          path: '**/build/reports/detekt/**'
          
      - name: Run ktlint
        run: ./gradlew ktlintCheck --stacktrace
        continue-on-error: true
        
      - name: Upload ktlint reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ktlint-reports
          path: '**/build/reports/ktlint/**'

  lint:
    name: Android Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Run Android Lint
        run: ./gradlew lintDebug --stacktrace
        continue-on-error: true
        
      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: lint-reports
          path: '**/build/reports/lint-results-*.html'

  build:
    name: Build APK
    runs-on: ubuntu-latest
    needs: [test, quality]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Build debug APK
        run: ./gradlew assembleDebug --stacktrace
        
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: debug-apk
          path: android/build/outputs/apk/debug/*.apk

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [test, coverage, quality, lint]
    if: always()
    
    steps:
      - name: Check quality gate
        run: |
          echo "Quality gate check"
          echo "All checks must pass for PR to be merged"
          
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Quality checks completed. Please review the test results and coverage reports.'
            })
