name: Database Migration Test

on:
  workflow_dispatch:
    inputs:
      from-version:
        description: 'Test migration from specific database version (leave empty for auto-detect)'
        required: false
        type: string
      previous-release-tag:
        description: 'Previous release tag to download database from (e.g., v1.2.0)'
        required: false
        type: string

jobs:
  # Job 1: Download previous release and extract database schema version
  prepare-previous-database:
    name: Prepare Previous Release Database
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      previous-db-version: ${{ steps.get-db-version.outputs.version }}
      previous-release-tag: ${{ steps.get-release.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Get previous release tag
        id: get-release
        run: |
          if [ -n "${{ github.event.inputs.previous-release-tag }}" ]; then
            PREV_TAG="${{ github.event.inputs.previous-release-tag }}"
          else
            # Get the latest stable release tag (excluding pre-releases)
            PREV_TAG=$(git tag --sort=-creatordate | grep -E '^v[0-9]+\.[0-9]+' | head -1)
            if [ -z "$PREV_TAG" ]; then
              # Fallback to any release tag
              PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            fi
          fi
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous release tag: $PREV_TAG"
      
      - name: Download previous release APK
        if: steps.get-release.outputs.tag != ''
        id: download-apk
        run: |
          PREV_TAG="${{ steps.get-release.outputs.tag }}"
          echo "Attempting to download APK from release: $PREV_TAG"
          
          # Try to download the APK from GitHub releases
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${PREV_TAG}"
          
          # Try different APK naming patterns
          APK_PATTERNS=(
            "IReader-arm64-v8a-standard-release-signed.apk"
            "IReader-*-standard-release-signed.apk"
            "*-arm64-v8a-*-signed.apk"
            "*-signed.apk"
          )
          
          APK_DOWNLOADED=false
          for pattern in "${APK_PATTERNS[@]}"; do
            # List assets from the release
            ASSETS=$(curl -s -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/${PREV_TAG}" \
              | jq -r '.assets[].name' 2>/dev/null || echo "")
            
            if [ -n "$ASSETS" ]; then
              # Find matching APK
              for asset in $ASSETS; do
                if [[ "$asset" == *.apk ]]; then
                  echo "Found APK: $asset"
                  ASSET_URL=$(curl -s -H "Accept: application/vnd.github.v3+json" \
                    "https://api.github.com/repos/${{ github.repository }}/releases/tags/${PREV_TAG}" \
                    | jq -r ".assets[] | select(.name==\"$asset\") | .browser_download_url")
                  
                  if [ -n "$ASSET_URL" ]; then
                    echo "Downloading from: $ASSET_URL"
                    curl -L -o previous-release.apk "$ASSET_URL" && APK_DOWNLOADED=true
                    break 2
                  fi
                fi
              done
            fi
          done
          
          if [ "$APK_DOWNLOADED" = true ]; then
            echo "apk_downloaded=true" >> $GITHUB_OUTPUT
          else
            echo "apk_downloaded=false" >> $GITHUB_OUTPUT
            echo "Could not download APK from previous release"
          fi
      
      - name: Extract database version from previous release
        id: get-db-version
        run: |
          if [ -n "${{ github.event.inputs.from-version }}" ]; then
            # Use manually specified version
            echo "version=${{ github.event.inputs.from-version }}" >> $GITHUB_OUTPUT
            echo "Using manually specified database version: ${{ github.event.inputs.from-version }}"
          elif [ "${{ steps.download-apk.outputs.apk_downloaded }}" = "true" ]; then
            # Extract database version from APK
            # Unzip APK and look for database schema info
            mkdir -p apk-contents
            unzip -q previous-release.apk -d apk-contents || true
            
            # Try to find database version from BuildConfig or resources
            DB_VERSION=""
            
            # Method 1: Check for database version in dex files (grep for CURRENT_VERSION)
            if command -v dexdump &> /dev/null; then
              DB_VERSION=$(dexdump apk-contents/classes*.dex 2>/dev/null | grep -oP 'CURRENT_VERSION.*?(\d+)' | grep -oP '\d+' | head -1 || echo "")
            fi
            
            # Method 2: Check assets for database files
            if [ -z "$DB_VERSION" ] && [ -d "apk-contents/assets" ]; then
              # Look for .db files that might indicate version
              find apk-contents/assets -name "*.db" -exec echo "Found database: {}" \;
            fi
            
            # Method 3: Infer from release tag
            if [ -z "$DB_VERSION" ]; then
              PREV_TAG="${{ steps.get-release.outputs.tag }}"
              # Map release versions to database versions (update this mapping as needed)
              case "$PREV_TAG" in
                v1.0.*) DB_VERSION=15 ;;
                v1.1.*) DB_VERSION=17 ;;
                v1.2.*) DB_VERSION=18 ;;
                *) DB_VERSION=18 ;;  # Default to recent version
              esac
              echo "Inferred database version $DB_VERSION from release tag $PREV_TAG"
            fi
            
            echo "version=$DB_VERSION" >> $GITHUB_OUTPUT
            echo "Previous database version: $DB_VERSION"
          else
            # Fallback: use version from current code minus 1
            CURRENT_VERSION=$(grep -oP 'CURRENT_VERSION\s*=\s*\K\d+' data/src/commonMain/kotlin/data/DatabaseMigrations.kt || echo "19")
            PREV_VERSION=$((CURRENT_VERSION - 1))
            echo "version=$PREV_VERSION" >> $GITHUB_OUTPUT
            echo "Using fallback database version: $PREV_VERSION"
          fi
      
      - name: Create test database at previous version
        run: |
          DB_VERSION="${{ steps.get-db-version.outputs.version }}"
          echo "Creating test database at version $DB_VERSION"
          
          # Create a directory for test databases
          mkdir -p test-databases
          
          # Store the version for later jobs
          echo "$DB_VERSION" > test-databases/previous-version.txt
      
      - name: Upload test database artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-database-info
          path: test-databases/

  # Job 2: Run migration tests with previous version database
  test-migration:
    name: Test Database Migration
    needs: [prepare-previous-database]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Download test database info
        uses: actions/download-artifact@v4
        with:
          name: test-database-info
          path: test-databases/
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Set previous database version
        id: set-version
        run: |
          if [ -f "test-databases/previous-version.txt" ]; then
            PREV_VERSION=$(cat test-databases/previous-version.txt)
          else
            PREV_VERSION="${{ needs.prepare-previous-database.outputs.previous-db-version }}"
          fi
          echo "PREVIOUS_DB_VERSION=$PREV_VERSION" >> $GITHUB_ENV
          echo "Testing migration from version: $PREV_VERSION"
      
      - name: Run database migration tests
        run: |
          echo "Running migration tests from version $PREVIOUS_DB_VERSION to current"
          ./gradlew :data:testDebugUnitTest --tests "ireader.data.DatabaseMigrationTest" --stacktrace \
            -Ptest.db.previous.version=$PREVIOUS_DB_VERSION
        continue-on-error: false
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-test-results
          path: |
            data/build/test-results/**/*.xml
            data/build/reports/tests/**
      
      - name: Comment on PR with results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v6
        with:
          script: |
            const prevVersion = '${{ needs.prepare-previous-database.outputs.previous-db-version }}';
            const prevTag = '${{ needs.prepare-previous-database.outputs.previous-release-tag }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ Database migration tests failed!\n\nTested migration from:\n- Previous release: \`${prevTag}\`\n- Database version: \`${prevVersion}\`\n\nPlease check the test results and ensure migrations work correctly before releasing.`
            })
      
      - name: Comment on PR with success
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v6
        with:
          script: |
            const prevVersion = '${{ needs.prepare-previous-database.outputs.previous-db-version }}';
            const prevTag = '${{ needs.prepare-previous-database.outputs.previous-release-tag }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ Database migration tests passed!\n\nSuccessfully tested migration from:\n- Previous release: \`${prevTag}\`\n- Database version: \`${prevVersion}\` → current`
            })

  # Job 3: Test migration on Android emulator with real database
  test-migration-android:
    name: Test Migration on Android Emulator
    needs: [prepare-previous-database]
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      
      - name: Download previous release APK (if available)
        id: download-prev
        run: |
          PREV_TAG="${{ needs.prepare-previous-database.outputs.previous-release-tag }}"
          if [ -n "$PREV_TAG" ]; then
            # Try to download previous APK for real migration test
            ASSETS=$(curl -s -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/${PREV_TAG}" \
              | jq -r '.assets[].name' 2>/dev/null || echo "")
            
            for asset in $ASSETS; do
              if [[ "$asset" == *"x86_64"*".apk" ]] || [[ "$asset" == *"x86-"*".apk" ]]; then
                ASSET_URL=$(curl -s -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/${{ github.repository }}/releases/tags/${PREV_TAG}" \
                  | jq -r ".assets[] | select(.name==\"$asset\") | .browser_download_url")
                
                if [ -n "$ASSET_URL" ]; then
                  echo "Downloading previous APK: $asset"
                  curl -L -o previous-release.apk "$ASSET_URL"
                  echo "apk_available=true" >> $GITHUB_OUTPUT
                  break
                fi
              fi
            done
          fi
          
          if [ ! -f "previous-release.apk" ]; then
            echo "apk_available=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Android migration test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          script: |
            # If we have a previous APK, install it first to create real database
            if [ -f "previous-release.apk" ]; then
              echo "Installing previous release APK to create database..."
              adb install -r previous-release.apk || true
              
              # Launch app briefly to initialize database
              adb shell am start -n org.ireader.app/.MainActivity || true
              sleep 10
              adb shell am force-stop org.ireader.app || true
              
              # Pull the database for inspection
              adb pull /data/data/org.ireader.app/databases/ ./pulled-databases/ || true
              
              echo "Previous database files:"
              ls -la ./pulled-databases/ || true
            fi
            
            # Run the migration tests
            ./gradlew :data:connectedAndroidTest --tests "ireader.data.*MigrationTest*" --stacktrace
        continue-on-error: true
      
      - name: Upload Android test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-migration-test-results
          path: |
            data/build/outputs/androidTest-results/**
            data/build/reports/androidTests/**
            pulled-databases/

  # Job 4: Test migration from multiple previous versions
  test-migration-multi-version:
    name: Test Migration from Multiple Versions
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        from-version: [15, 16, 17, 18]
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Run migration test from version ${{ matrix.from-version }}
        run: |
          echo "Testing migration from version ${{ matrix.from-version }} to current"
          ./gradlew :data:testDebugUnitTest \
            --tests "ireader.data.DatabaseMigrationTest.testMigrationFrom${{ matrix.from-version }}ToCurrent" \
            --stacktrace || true
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-test-v${{ matrix.from-version }}-results
          path: |
            data/build/test-results/**/*.xml
            data/build/reports/tests/**

  # Job 5: Migration gate - blocks release if tests fail
  migration-gate:
    name: Migration Test Gate
    runs-on: ubuntu-latest
    needs: [test-migration, test-migration-android, test-migration-multi-version]
    if: always()
    
    steps:
      - name: Check migration tests passed
        run: |
          echo "Test Migration Result: ${{ needs.test-migration.result }}"
          echo "Android Migration Result: ${{ needs.test-migration-android.result }}"
          echo "Multi-Version Migration Result: ${{ needs.test-migration-multi-version.result }}"
          
          if [ "${{ needs.test-migration.result }}" != "success" ]; then
            echo "❌ Core migration tests failed!"
            echo "Database migrations must pass before release."
            exit 1
          fi
          
          # Android tests are informational (may fail due to emulator issues)
          if [ "${{ needs.test-migration-android.result }}" == "failure" ]; then
            echo "⚠️ Android migration tests failed (non-blocking)"
          fi
          
          echo "✅ Core migration tests passed!"
      
      - name: Create status check
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const testResult = '${{ needs.test-migration.result }}';
            const androidResult = '${{ needs.test-migration-android.result }}';
            const multiResult = '${{ needs.test-migration-multi-version.result }}';
            
            const conclusion = testResult === 'success' ? 'success' : 'failure';
            
            let summary = '';
            if (conclusion === 'success') {
              summary = '✅ Database migration tests passed\n\n';
              summary += `- Core tests: ${testResult}\n`;
              summary += `- Android tests: ${androidResult}\n`;
              summary += `- Multi-version tests: ${multiResult}`;
            } else {
              summary = '❌ Database migration tests failed\n\n';
              summary += 'Please fix migration issues before releasing.';
            }
            
            github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Database Migration Gate',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'Database Migration Test',
                summary: summary
              }
            });
