// Cheerio implementation using native jsoup bridge
(function() {
  if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
      load: function(html) {
        // Use the native cheerio API provided by JSLibraryProvider
        if (typeof __nativeCheerio !== 'undefined') {
          const nativeResult = __nativeCheerio.load(html);
          
          // Create a wrapper function that can be called as $(selector)
          const wrapCheerioObject = function(nativeObj) {
            const cheerioFn = function(selector) {
              if (typeof selector === 'string') {
                return wrapCheerioObject(nativeObj.invoke(selector));
              }
              return nativeObj;
            };
            
            // Copy all methods from the native object to the function
            for (const key in nativeObj) {
              if (key === 'map') {
                // Special handling for map to support JavaScript callbacks
                cheerioFn.map = function(callback) {
                  const results = [];
                  const length = nativeObj.length || 0;
                  for (let i = 0; i < length; i++) {
                    const el = nativeObj.get(i);
                    const result = callback.call(el, i, el);
                    results.push(result);
                  }
                  return {
                    get: function() { return results; },
                    toArray: function() { return results; }
                  };
                };
              } else if (typeof nativeObj[key] === 'function') {
                cheerioFn[key] = function(...args) {
                  const result = nativeObj[key](...args);
                  // If result is a CheerioObject, wrap it
                  if (result && typeof result === 'object' && result.find) {
                    return wrapCheerioObject(result);
                  }
                  return result;
                };
              } else {
                cheerioFn[key] = nativeObj[key];
              }
            }
            
            return cheerioFn;
          };
          
          return wrapCheerioObject(nativeResult);
        }
        throw new Error('Native Cheerio bridge not available');
      }
    };
  }
})();
