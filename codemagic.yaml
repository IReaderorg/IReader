workflows:
  # ============================================
  # iOS Build & Test Workflow
  # ============================================
  ios-build:
    name: iOS Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    
    environment:
      ios_signing:
        distribution_type: development
        bundle_identifier: com.infinity.iosApp
      vars:
        XCODE_WORKSPACE: "iosApp/iosApp.xcodeproj"
        XCODE_SCHEME: "iosApp"
        BUNDLE_ID: "com.infinity.iosApp"
      xcode: 15.4
      java: 17
      cocoapods: default
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: 'main'
          include: true
        - pattern: 'develop'
          include: true
        - pattern: 'feature/*'
          include: true
        - pattern: 'ios/*'
          include: true
      cancel_previous_builds: true
    
    scripts:
      # Setup environment
      - name: Set up local.properties
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          # Add placeholder Supabase config for build
          echo "supabase.auth.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.auth.key=placeholder-key" >> local.properties
          echo "supabase.reading.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.reading.key=placeholder-key" >> local.properties
          echo "supabase.library.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.library.key=placeholder-key" >> local.properties
          echo "supabase.book_reviews.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.book_reviews.key=placeholder-key" >> local.properties
          echo "supabase.chapter_reviews.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.chapter_reviews.key=placeholder-key" >> local.properties
          echo "supabase.badges.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.badges.key=placeholder-key" >> local.properties
          echo "supabase.analytics.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.analytics.key=placeholder-key" >> local.properties
      
      # Install CocoaPods dependencies
      - name: Install CocoaPods
        script: |
          cd iosApp
          pod install --repo-update || echo "No Pods to install"
      
      # Build Kotlin framework for iOS
      - name: Build Kotlin Framework
        script: |
          ./gradlew :ios-build-check:embedAndSignAppleFrameworkForXcode \
            -PXCODE_CONFIGURATION=Release \
            -PSDK_NAME=iphonesimulator \
            --no-daemon
      
      # Build iOS app (simulator)
      - name: Build iOS App (Simulator)
        script: |
          xcodebuild build \
            -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -allowProvisioningUpdates \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      # Run iOS tests (if available)
      - name: Run iOS Tests
        script: |
          xcodebuild test \
            -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO || echo "No tests configured"
        ignore_failure: true
    
    artifacts:
      - iosApp/build/ios/**/*.app
      - ios-build-check/build/**/*.framework
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - your-email@example.com  # Replace with your email
        notify:
          success: false
          failure: true

  # ============================================
  # iOS Release Build (with signing)
  # ============================================
  ios-release:
    name: iOS Release Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.infinity.iosApp
      vars:
        XCODE_WORKSPACE: "iosApp/iosApp.xcodeproj"
        XCODE_SCHEME: "iosApp"
        BUNDLE_ID: "com.infinity.iosApp"
        # Add your Supabase secrets in Codemagic UI
        # SUPABASE_URL: Encrypted(...)
        # SUPABASE_KEY: Encrypted(...)
      xcode: 15.4
      java: 17
      cocoapods: default
    
    triggering:
      events:
        - tag
      tag_patterns:
        - pattern: 'v*'
          include: true
        - pattern: 'ios-*'
          include: true
    
    scripts:
      - name: Set up local.properties
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          # Use environment variables for secrets (set in Codemagic UI)
          echo "supabase.auth.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.auth.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.reading.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.reading.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.library.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.library.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.book_reviews.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.book_reviews.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.chapter_reviews.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.chapter_reviews.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.badges.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.badges.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.analytics.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.analytics.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
      
      - name: Install CocoaPods
        script: |
          cd iosApp
          pod install --repo-update || echo "No Pods to install"
      
      - name: Build Kotlin Framework
        script: |
          ./gradlew :ios-build-check:embedAndSignAppleFrameworkForXcode \
            -PXCODE_CONFIGURATION=Release \
            -PSDK_NAME=iphoneos \
            --no-daemon
      
      - name: Build iOS App (Release)
        script: |
          xcodebuild archive \
            -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -configuration Release \
            -archivePath build/iosApp.xcarchive \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates
      
      - name: Export IPA
        script: |
          xcodebuild -exportArchive \
            -archivePath build/iosApp.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist iosApp/ExportOptions.plist \
            -allowProvisioningUpdates
    
    artifacts:
      - build/ipa/*.ipa
      - build/iosApp.xcarchive
    
    publishing:
      app_store_connect:
        # Configure in Codemagic UI with your App Store Connect API key
        auth: integration
        submit_to_testflight: true

  # ============================================
  # Kotlin Multiplatform Tests (No Mac needed)
  # ============================================
  kmp-tests:
    name: KMP Shared Code Tests
    max_build_duration: 60
    instance_type: linux_x2
    
    environment:
      java: 17
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: '*'
          include: true
      cancel_previous_builds: true
    
    scripts:
      - name: Set up local.properties
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "supabase.auth.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.auth.key=placeholder-key" >> local.properties
          echo "supabase.reading.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.reading.key=placeholder-key" >> local.properties
          echo "supabase.library.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.library.key=placeholder-key" >> local.properties
          echo "supabase.book_reviews.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.book_reviews.key=placeholder-key" >> local.properties
          echo "supabase.chapter_reviews.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.chapter_reviews.key=placeholder-key" >> local.properties
          echo "supabase.badges.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.badges.key=placeholder-key" >> local.properties
          echo "supabase.analytics.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.analytics.key=placeholder-key" >> local.properties
      
      - name: Run Common Tests
        script: |
          ./gradlew :core:jvmTest :domain:jvmTest :data:jvmTest --no-daemon || echo "Tests completed"
        ignore_failure: true
      
      - name: Check Compilation
        script: |
          ./gradlew :presentation:compileKotlinDesktop --no-daemon
    
    artifacts:
      - "**/build/reports/**"
      - "**/build/test-results/**"
