workflows:
  # ============================================
  # iOS Build & Test Workflow
  # ============================================
  ios-build:
    name: iOS Build
    max_build_duration: 120
    instance_type: mac_mini_m2
    
    environment:
      # No ios_signing needed for simulator builds!
      vars:
        XCODE_WORKSPACE: "iosApp/iosApp.xcodeproj"
        XCODE_SCHEME: "iosApp"
        BUNDLE_ID: "com.infinity.iosApp"
      xcode: latest
      java: 17
      cocoapods: default
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: 'main'
          include: true
        - pattern: 'develop'
          include: true
        - pattern: 'feature/*'
          include: true
        - pattern: 'ios/*'
          include: true
      cancel_previous_builds: true
    
    scripts:
      # Setup environment
      - name: Set up local.properties
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          # Add placeholder Supabase config for build
          echo "supabase.auth.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.auth.key=placeholder-key" >> local.properties
          echo "supabase.reading.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.reading.key=placeholder-key" >> local.properties
          echo "supabase.library.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.library.key=placeholder-key" >> local.properties
          echo "supabase.book_reviews.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.book_reviews.key=placeholder-key" >> local.properties
          echo "supabase.chapter_reviews.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.chapter_reviews.key=placeholder-key" >> local.properties
          echo "supabase.badges.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.badges.key=placeholder-key" >> local.properties
          echo "supabase.analytics.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.analytics.key=placeholder-key" >> local.properties
      
      # Install CocoaPods dependencies
      - name: Install CocoaPods
        script: |
          cd iosApp
          pod install --repo-update || echo "No Pods to install"
      
      # Build Kotlin framework for iOS Simulator
      - name: Build Kotlin Framework
        script: |
          # Build Debug framework to avoid heavy LTO/devirtualization optimizations that cause OOM
          # Debug builds are faster and use less memory
          ./gradlew :presentation:linkDebugFrameworkIosSimulatorArm64 \
            --no-daemon \
            --no-configuration-cache \
            -Dorg.gradle.jvmargs="-Xmx6g -XX:+UseG1GC -XX:MaxMetaspaceSize=1g" \
            -Pkotlin.native.cacheKind=none \
            -Pkotlin.native.binary.memoryModel=experimental
          
          # Copy framework to expected location for Xcode
          FRAMEWORK_PATH="presentation/build/bin/iosSimulatorArm64/debugFramework"
          DEST_PATH="presentation/build/xcode-frameworks/Debug/iphonesimulator"
          mkdir -p "$DEST_PATH"
          cp -R "$FRAMEWORK_PATH"/* "$DEST_PATH/" || echo "Framework copy skipped"
      
      # Build iOS app (simulator)
      - name: Build iOS App (Simulator)
        script: |
          # Find first available iPhone simulator
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '[A-F0-9-]{36}')
          echo "Using simulator: $SIMULATOR_ID"
          
          # If no iPhone found, use any simulator
          if [ -z "$SIMULATOR_ID" ]; then
            SIMULATOR_ID=$(xcrun simctl list devices available | grep -oE '[A-F0-9-]{36}' | head -1)
          fi
          
          # List framework location for debugging
          echo "Framework location:"
          ls -la presentation/build/xcode-frameworks/Debug/iphonesimulator/ || echo "xcode-frameworks not found"
          ls -la presentation/build/bin/iosSimulatorArm64/debugFramework/ || echo "debugFramework not found"
          
          xcodebuild build \
            -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -configuration Debug \
            -destination "id=$SIMULATOR_ID" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      # Run iOS tests (if available)
      - name: Run iOS Tests
        script: |
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '[A-F0-9-]{36}')
          if [ -z "$SIMULATOR_ID" ]; then
            SIMULATOR_ID=$(xcrun simctl list devices available | grep -oE '[A-F0-9-]{36}' | head -1)
          fi
          
          xcodebuild test \
            -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -destination "id=$SIMULATOR_ID" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO || echo "No tests configured"
        ignore_failure: true
    
    artifacts:
      - iosApp/build/ios/**/*.app
      - presentation/build/**/*.framework
      - /tmp/xcodebuild_logs/*.log
    
    publishing:
      email:
        recipients:
          - your-email@example.com  # Replace with your email
        notify:
          success: false
          failure: true

  # ============================================
  # AltStore / Sideloading Build (Unsigned IPA)
  # ============================================
  # This creates an unsigned IPA that can be installed via:
  # - AltStore (recommended)
  # - Sideloadly
  # - 3uTools
  # - Other sideloading tools
  ios-sideload:
    name: iOS Sideload Build (AltStore)
    max_build_duration: 120
    instance_type: mac_mini_m2
    
    environment:
      # No signing needed - AltStore will sign with user's Apple ID
      vars:
        XCODE_SCHEME: "iosApp"
        BUNDLE_ID: "com.infinity.iosApp"
      xcode: latest
      java: 17
      cocoapods: default
    
    triggering:
      events:
        - tag
        - push
      tag_patterns:
        - pattern: 'v*'
          include: true
        - pattern: 'sideload-*'
          include: true
      branch_patterns:
        - pattern: 'main'
          include: true
        - pattern: 'release/*'
          include: true
    
    scripts:
      - name: Set up local.properties
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "supabase.auth.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.auth.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.reading.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.reading.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.library.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.library.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.book_reviews.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.book_reviews.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.chapter_reviews.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.chapter_reviews.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.badges.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.badges.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
          echo "supabase.analytics.url=${SUPABASE_URL:-https://placeholder.supabase.co}" >> local.properties
          echo "supabase.analytics.key=${SUPABASE_KEY:-placeholder-key}" >> local.properties
      
      - name: Install CocoaPods
        script: |
          cd iosApp
          pod install --repo-update || echo "No Pods to install"
      
      - name: Build Kotlin Framework
        script: |
          # Build Debug framework first to verify it works, then try Release
          # Debug builds skip heavy LTO/devirtualization that cause OOM
          ./gradlew :presentation:linkDebugFrameworkIosArm64 \
            --no-daemon \
            --no-configuration-cache \
            -Dorg.gradle.jvmargs="-Xmx6g -XX:+UseG1GC -XX:MaxMetaspaceSize=1g" \
            -Pkotlin.native.cacheKind=none \
            -Pkotlin.native.binary.memoryModel=experimental
          
          # Copy framework to expected location
          FRAMEWORK_PATH="presentation/build/bin/iosArm64/debugFramework"
          DEST_PATH="presentation/build/xcode-frameworks/Debug/iphoneos"
          mkdir -p "$DEST_PATH"
          cp -R "$FRAMEWORK_PATH"/* "$DEST_PATH/" || echo "Framework copy skipped"
      
      - name: Build Unsigned App
        script: |
          # Build for real device without signing (using Debug framework)
          xcodebuild build \
            -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -configuration Debug \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build/DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            FRAMEWORK_SEARCH_PATHS="\$(inherited) \$(SRCROOT)/../presentation/build/bin/iosArm64/debugFramework"
      
      - name: Create Unsigned IPA
        script: |
          # Find the .app bundle
          APP_PATH=$(find build/DerivedData -name "*.app" -type d | head -1)
          echo "Found app at: $APP_PATH"
          
          # Create Payload directory structure
          mkdir -p build/Payload
          cp -r "$APP_PATH" build/Payload/
          
          # Create the IPA (it's just a zip file)
          cd build
          zip -r Infinity-unsigned.ipa Payload
          
          # Also create with version in filename
          VERSION=$(date +%Y%m%d-%H%M%S)
          cp Infinity-unsigned.ipa "Infinity-${VERSION}-sideload.ipa"
          
          echo "âœ… Created unsigned IPA for sideloading!"
          ls -la *.ipa
    
    artifacts:
      - build/*.ipa
      - build/Payload/**/*.app
    
    publishing:
      email:
        recipients:
          - your-email@example.com
        notify:
          success: true
          failure: true

  # ============================================
  # Kotlin Multiplatform Tests (No Mac needed)
  # ============================================
  kmp-tests:
    name: KMP Shared Code Tests
    max_build_duration: 60
    instance_type: linux_x2
    
    environment:
      java: 17
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: '*'
          include: true
      cancel_previous_builds: true
    
    scripts:
      - name: Set up local.properties
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "supabase.auth.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.auth.key=placeholder-key" >> local.properties
          echo "supabase.reading.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.reading.key=placeholder-key" >> local.properties
          echo "supabase.library.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.library.key=placeholder-key" >> local.properties
          echo "supabase.book_reviews.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.book_reviews.key=placeholder-key" >> local.properties
          echo "supabase.chapter_reviews.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.chapter_reviews.key=placeholder-key" >> local.properties
          echo "supabase.badges.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.badges.key=placeholder-key" >> local.properties
          echo "supabase.analytics.url=https://placeholder.supabase.co" >> local.properties
          echo "supabase.analytics.key=placeholder-key" >> local.properties
      
      - name: Run Common Tests
        script: |
          ./gradlew :core:jvmTest :domain:jvmTest :data:jvmTest --no-daemon || echo "Tests completed"
        ignore_failure: true
      
      - name: Check Compilation
        script: |
          ./gradlew :presentation:compileKotlinDesktop --no-daemon
    
    artifacts:
      - "**/build/reports/**"
      - "**/build/test-results/**"
